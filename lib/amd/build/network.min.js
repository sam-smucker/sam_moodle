/**
 * Poll the server to keep the session alive.
 *
 * @module     core/network
 * @copyright  2019 Damyon Wiese
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("core/network",["jquery","core/ajax","core/config","core/notification","core/str","core/modal_save_cancel","core/modal_events","core/network_events"],(function($,Ajax,Config,Notification,Str,SaveCancelModal,ModalEvents,NetworkEvents){var started=!1,warningDisplayed=!1,keepAliveFrequency=0,requestTimeout=0,keepAliveMessage=!1,sessionTimeout=!1,checkFrequency=1e3*Math.min(Config.sessiontimeout/10,600),warningLimit=Config.sessiontimeoutwarning>0?1e3*Config.sessiontimeoutwarning:2*checkFrequency,firstWait=Config.sessiontimeoutwarning>0?Math.min(1e3*(Config.sessiontimeout-Config.sessiontimeoutwarning),5*checkFrequency):5*checkFrequency,alertModal=null,redirectUrl=null,connectionRetries=0,timeoutSessionExpired=function(modal){sessionTimeout=!0,warningDisplayed=!1,closeModal(modal),displaySessionExpired()},closeModal=function(modal){modal.destroy()},displaySessionExpired=function(){return Ajax.call([{methodname:"core_session_time_remaining",args:{}}],!0,!0,!0)[0].then((function(args){return!(1e3*args.timeremaining>warningLimit)&&Str.get_strings([{key:"sessionexpired",component:"error"},{key:"sessionerroruser",component:"error"},{key:"loginagain",component:"moodle"},{key:"cancel",component:"moodle"}]).then((function(strings){return Notification.confirm(strings[0],strings[1],strings[2],strings[3],(function(){return location.reload(),!0})),!0})).catch(Notification.exception)}))},touchSession=function(){return sessionTimeout?displaySessionExpired():Ajax.call([{methodname:"core_session_touch",args:{}}],!0,!0,!1,requestTimeout)[0].then((function(){return window.dispatchEvent(new CustomEvent(NetworkEvents.sessionTouched)),!0})).catch((function(){window.dispatchEvent(new CustomEvent(NetworkEvents.unstableConnection))}))},checkSession=function(){return sessionTimeout=!1,Ajax.call([{methodname:"core_session_time_remaining",args:{}}],!0,!0,!0)[0].then((function(args){return!(args.userid<=0)&&(args.timeremaining<=0?displaySessionExpired():(1e3*args.timeremaining<=warningLimit&&!warningDisplayed?(warningDisplayed=!0,Str.get_strings([{key:"norecentactivity",component:"moodle"},{key:"sessiontimeoutsoon",component:"moodle"},{key:"extendsession",component:"moodle"},{key:"cancel",component:"moodle"}]).then((function(strings){return Notification.confirm(strings[0],strings[1],strings[2],strings[3],(function(){return touchSession(),warningDisplayed=!1,setTimeout(checkSession,firstWait),!0}),(function(){setTimeout(checkSession,checkFrequency)}))})).then((modal=>{setTimeout(timeoutSessionExpired,1e3*args.timeremaining,modal)})).catch(Notification.exception)):setTimeout(checkSession,checkFrequency),!0))}))},start=function(){keepAliveFrequency>0?setTimeout(touchSession,keepAliveFrequency):setTimeout(checkSession,firstWait)};const isMoodleIframe=function(){if(window.parent===window)return!1;let parentUrl;try{parentUrl=window.parent.location.href}catch(e){return!1}return parentUrl.startsWith(M.cfg.wwwroot)};var leavePage=function(){"string"!=typeof redirectUrl?window.location.reload():window.location.replace(redirectUrl)},handleUnstableConnection=function(){if(connectionRetries<1)return alertModal.show(),setTimeout(touchSession,keepAliveFrequency),void connectionRetries++;null!==alertModal&&(alertModal.getRoot().find('[data-action="cancel"]').hide(),alertModal.show().then((function(){alertModal.getRoot().on(ModalEvents.hidden,leavePage)})))},handleSessionTouched=function(){keepAliveFrequency>0&&(setTimeout(touchSession,keepAliveFrequency),connectionRetries=0)};return{keepalive:async function(freq,timeout,identifier,component){let redirect=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(started)window.console.warn("Ignoring session keep-alive. The core/network module was already initialised.");else if(started=!0,isMoodleIframe())window.console.warn("Ignoring session keep-alive in this iframe inside another Moodle page.");else{window.console.log("Starting Moodle session keep-alive."),keepAliveFrequency=1e3*freq,keepAliveMessage=await Str.get_string(identifier,component),requestTimeout=1e3*timeout,redirectUrl=redirect;var strings=await Str.get_strings([{key:"unstablenetwork",component:"mod_scorm"},{key:"leavepage",component:"mod_scorm"},{key:"refresh",component:"moodle"}]);(alertModal=await SaveCancelModal.create({title:strings[0],body:keepAliveMessage,buttons:{save:"string"==typeof redirectUrl?strings[1]:strings[2]},removeOnClose:!1,show:!1})).getRoot().on(ModalEvents.save,leavePage),window.addEventListener(NetworkEvents.sessionTouched,handleSessionTouched),window.addEventListener(NetworkEvents.unstableConnection,handleUnstableConnection),start()}},init:function(){started||(started=!0,isMoodleIframe()?window.console.log("Not starting Moodle session timeout warning in this iframe."):(window.console.log("Starting Moodle session timeout warning."),start()))}}}));

//# sourceMappingURL=network.min.js.map